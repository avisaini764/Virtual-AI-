<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Virtual Voice Assistant</title>
    <link rel="icon" type="image/png" href="title.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b1220;
            --card-bg: rgba(30, 39, 66, 0.4);
            --card-2-bg: rgba(255, 255, 255, 0.05);
            --card-hover-bg: rgba(255, 255, 255, 0.1);
            --text: #e6eef8;
            --muted: #9fb0cc;
            --accent: #8a70ff;
            --accent-rgb: 138, 112, 255;
            --accent-hover: #7c5cff;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --font-family: 'Inter', Arial, system-ui, sans-serif;
        }
        
        html[data-theme="light"] {
            --bg: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-2-bg: rgba(0, 0, 0, 0.03);
            --card-hover-bg: rgba(0, 0, 0, 0.05);
            --text: #212529;
            --muted: #6c757d;
            --shadow-color: rgba(90, 90, 90, 0.2);
        }
        * { box-sizing: border-box; }
        
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            margin: 0;
            font-family: var(--font-family);
            background: linear-gradient(-45deg, #0b1220, #131b33, #0b1220, #1c2a4e);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
            perspective: 1500px;
        }
        html[data-theme="light"] body {
             background: linear-gradient(-45deg, #e7e9f0, #ffffff, #d7d9e0, #f0f2f5);
        }
        
        .wrap { 
            max-width: 1000px; 
            width: 100%;
            padding: 0 20px; 
            transform-style: preserve-3d;
        }

        header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
        .brand { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .logo, .brand h1 {
            transition: transform 0.3s ease;
        }
        .brand:hover .logo, .brand:hover h1 {
            transform: translateY(-2px) translateZ(15px);
        }
        .logo { width: 52px; height: 52px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #22c1c3); display: grid; place-items: center; color: #fff; font-size: 24px; }
        h1 { margin: 0; font-size: 20px; }
        .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

        button {
            padding: 10px 14px; border-radius: 10px; cursor: pointer; background: var(--accent); color: #fff; font-weight: 600; font-family: var(--font-family);
            display: flex; align-items: center; gap: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        button:not(.ghost)::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 75%;
            height: 100%;
            background: linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
            transform: skewX(-25deg);
            transition: left 0.6s ease;
        }
        button:hover { 
            transform: translateY(-2px) translateZ(20px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 20px rgba(var(--accent-rgb), 0.5);
        }
        button:not(.ghost):hover::before {
            left: 120%;
        }
        button:active { transform: scale(0.97) translateZ(10px); }
        .ghost { background: transparent; color: var(--text); border: 1px solid rgba(255,255,255,0.2);}
        .ghost:hover { background: var(--card-hover-bg); }

        .input-container { position: relative; display: flex; align-items: center; }
        input[type="text"] {
            -webkit-appearance: none;
            appearance: none;
            padding: 10px 32px 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); min-width: 240px; background: rgba(0,0,0,0.2); color: var(--text);
            font-family: var(--font-family); font-size: 14px;
        }
        .clear-btn {
            position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: var(--muted); cursor: pointer; font-size: 22px; padding: 0 8px; line-height: 1;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
        }
        .clear-btn.visible { opacity: 1; pointer-events: auto; }
        
        main { 
            display: grid; grid-template-columns: 1fr 320px; gap: 24px; 
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .panel { 
            background: var(--card-bg);
            border-radius: 16px; 
            padding: 20px; 
            box-shadow: 0 8px 30px var(--shadow-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .panel::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -1px; 
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
        }
        
        #left { min-height: 420px; }
        #youSaid { font-size: 14px; color: var(--muted); margin-bottom: 16px; min-height: 20px;}
        #output { display: grid; gap: 16px; }

        .card, .hist-item {
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover, .hist-item:hover {
            transform: translateY(-2px) translateZ(15px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 15px rgba(var(--accent-rgb), 0.2);
        }

        .card { 
            display: flex; gap: 16px; border-radius: 12px; padding: 16px; background: var(--card-2-bg); align-items: flex-start; animation: fadeIn 0.5s ease;
        }
        .thumb { width: 120px; height: 80px; object-fit: cover; border-radius: 8px; background: #0f1724; flex-shrink: 0; }
        .meta { flex: 1; }
        .meta h3 { margin: 0; font-size: 16px; }
        .meta p, .meta div.small { margin: 6px 0 0; font-size: 13px; color: var(--muted); line-height: 1.5; }
        .small { font-size: 13px; color: var(--muted); }
        .history { display: grid; gap: 8px; max-height: 420px; overflow-y: auto; padding-right: 8px; }
        .hist-item { padding: 10px; border-radius: 8px; background: var(--card-2-bg); font-size: 13px; cursor: pointer; }
        .hist-item:hover { background: var(--card-hover-bg); }
        .hist-item div:first-child { color: var(--muted); }
        a.link { color: var(--accent); text-decoration: none; font-weight: 600; }
        .loader { width: 32px; height: 32px; border: 4px solid var(--accent); border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; margin: 20px auto; }
        
        html[data-theme="light"] .panel::before {
             background: linear-gradient(135deg, rgba(0,0,0,0.15), rgba(0,0,0,0.05));
        }
        html[data-theme="light"] button,
        html[data-theme="light"] .ghost,
        html[data-theme="light"] input[type="text"],
        html[data-theme="light"] .card,
        html[data-theme="light"] .hist-item {
            border-color: rgba(0,0,0,0.12);
        }
        html[data-theme="light"] input[type="text"] {
             background: rgba(0,0,0,0.02);
        }
        html[data-theme="light"] button:hover {
            box-shadow: 0 8px 20px var(--shadow-color), 0 0 20px rgba(var(--accent-rgb), 0.4);
        }
        html[data-theme="light"] .card:hover,
        html[data-theme="light"] .hist-item:hover {
            box-shadow: 0 8px 20px var(--shadow-color), 0 0 15px rgba(var(--accent-rgb), 0.1);
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button.listening .mic-icon { animation: pulse 1.s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        
        footer { margin-top: 24px; text-align: center; color: var(--muted); font-size: 13px; }
        
        /* =================================================================== */
        /* --- RESPONSIVENESS CODE FOR ALL DEVICES --- */
        /* =================================================================== */
        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
            }
            #left { order: 1; }
            aside { order: 2; }
        }
        @media (max-width: 600px) {
            body {
                display: block;
                padding: 0;
            }
            .wrap {
                padding: 16px;
            }
            header {
                gap: 20px;
            }
            .controls {
                width: 100%;
                justify-content: flex-start;
            }
            .input-container {
                flex-grow: 1;
            }
            input[type="text"] {
                min-width: 100px;
                width: 100%;
            }
            .card {
                flex-direction: column;
            }
            .thumb {
                width: 100%;
                height: 150px;
            }
            h1 {
                font-size: 18px;
            }
            main, button:hover, .card:hover, .hist-item:hover, .brand:hover .logo, .brand:hover h1 {
                transform: none;
            }
            button:hover {
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }
            html[data-theme="light"] button:hover {
                 box-shadow: 0 4px 15px var(--shadow-color);
            }
            button:active {
                transform: scale(0.97);
            }
            .brand .small {
                display: none;
            }
        }
    </style>
</head>
<body>
<div id="shootingStars"></div>
<div class="wrap" id="app">
    <header>
        <div class="brand">
            <div class="logo">💀</div>
            <div>
                <h1>Virtual Voice Assistant</h1>
                <div class="small">Try: news / weather in Delhi / what is India / joke</div>
            </div>
        </div>
        <div class="controls">
            <div class="input-container">
                <input id="textInput" placeholder="Search ..." autocomplete="off" />
                <button id="clearInputBtn" class="clear-btn" title="Clear input">&times;</button>
            </div>
            <button id="runBtn">Run</button>
            <button id="speakBtn"><span class="mic-icon">🎤</span> Speak</button>
            <button id="ttsBtn" class="ghost" title="Toggle Text-to-Speech">🔊</button>
            <button id="themeBtn" class="ghost" title="Toggle Theme">☀️</button>
        </div>
    </header>

    <main>
        <section id="left" class="panel">
            <div id="youSaid" class="small">—</div>
            <div id="output">
                <div class="card">
                    <div class="meta">
                        <h3>Welcome!</h3>
                        <p class="small">Click the 'Speak' button or type a command to get started.</p>
                    </div>
                </div>
            </div>
        </section>

        <aside class="panel">
            <strong>History</strong>
            <div class="history" id="history"></div>
            <button id="clearHistoryBtn" class="ghost" style="margin-top:12px; width: 100%;">Clear History</button>
        </aside>
    </main>

    <footer>
        <p>Powered by Avi Saini. Local demo running on your machine</p>
    </footer>
</div>

<script>
// =================================================================================
// 1. SETUP & CONFIG
// =================================================================================
const UI = {
    output: document.getElementById('output'),
    youSaid: document.getElementById('youSaid'),
    runBtn: document.getElementById('runBtn'),
    speakBtn: document.getElementById('speakBtn'),
    textInput: document.getElementById('textInput'),
    clearInputBtn: document.getElementById('clearInputBtn'),
    historyDiv: document.getElementById('history'),
    clearHistoryBtn: document.getElementById('clearHistoryBtn'),
    themeBtn: document.getElementById('themeBtn'),
    ttsBtn: document.getElementById('ttsBtn')
};
const appState = {
    isListening: false,
    history: JSON.parse(localStorage.getItem('va_history') || '[]'),
    ttsEnabled: JSON.parse(localStorage.getItem('va_ttsEnabled') || 'true')
};
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;

// =================================================================================
// 2. HELPER FUNCTIONS
// =================================================================================
const escapeHtml = s => s?.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;") ?? "";
function speak(text) {
    if (!appState.ttsEnabled || !window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    speechSynthesis.speak(utterance);
}

// =================================================================================
// 3. API HELPERS
// =================================================================================
const api = {
    async get(path) {
        const response = await fetch(path);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `${response.status} ${response.statusText}`);
        }
        return response.json();
    },
    getNews: () => api.get('/get_news'),
    getWeather: city => api.get(`/get_weather?city=${encodeURIComponent(city)}`),
    getWikipedia: query => api.get(`/search_wikipedia?query=${encodeURIComponent(query)}`),
    // Note: The original 'playYoutube' is removed as we now handle it on the client-side for better compatibility.
    searchGoogle: query => api.get(`/search_google?query=${encodeURIComponent(query)}`),
    getJoke: () => api.get('/get_joke'),
    getQuote: () => api.get('/get_quote')
};

// =================================================================================
// 4. RENDER FUNCTIONS
// =================================================================================
const render = {
    loading: () => `<div class="loader"></div>`,
    error: message => `<div class="card"><div class="meta"><h3>Error</h3><p class="small">${escapeHtml(message)}</p></div></div>`,
    card: (title, content) => `<div class="card"><div class="meta"><h3>${escapeHtml(title)}</h3><div class="small">${content}</div></div></div>`,
    news: articles => `<h3>📰 Latest News</h3>` + articles.map(n => `<div class="card"><div class="meta"><h3>${escapeHtml(n.title || 'No title')}</h3>${n.description ? `<p class="small">${escapeHtml(n.description)}</p>` : ''}${n.source ? `<div class="small">Source: ${escapeHtml(n.source)}</div>` : ''}${n.link ? `<a class="link" href="${n.link}" target="_blank">Read Full Article →</a>` : ''}</div>${n.image ? `<img class="thumb" src="${n.image}" alt="">` : ''}</div>`).join(''),
    weather: (data, city) => {
        const temp = (data.main.temp - 273.15).toFixed(1);
        const desc = data.weather[0].description || '';
        const iconUrl = data.weather[0].icon ? `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png` : '';
        return `<div class="card"><div class="meta"><h3>Weather in ${escapeHtml(city)}</h3><div class="small">Temperature: ${temp}°C</div><div class="small">Condition: ${escapeHtml(desc)}</div></div>${iconUrl ? `<img class="thumb" style="width:80px;height:80px;" src="${iconUrl}" alt="Weather icon">` : ''}</div>`;
    },
    wikipedia: r => `<div class="card"><div class="meta"><h3>${escapeHtml(r.title)}</h3><p class="small">${escapeHtml(r.extract)}</p><a class="link" href="${r.url}" target="_blank">Read on Wikipedia →</a></div>${r.thumbnail ? `<img class="thumb" src="${r.thumbnail}" alt="">` : ''}</div>`
};

// =================================================================================
// 5. HISTORY MANAGEMENT
// =================================================================================
function saveHistory() {
    localStorage.setItem('va_history', JSON.stringify(appState.history));
    renderHistory();
}
function pushHistory(cmd, summary) {
    appState.history.unshift({ cmd, summary, ts: new Date().toLocaleString() });
    if (appState.history.length > 40) appState.history.length = 40;
    saveHistory();
}
function renderHistory() {
    UI.historyDiv.innerHTML = appState.history.map(h => `<div class="hist-item" data-command="${escapeHtml(h.cmd)}"><div class="small">${escapeHtml(h.ts)}</div><div><strong>${escapeHtml(h.cmd)}</strong></div><div class="small">${escapeHtml(h.summary || '')}</div></div>`).join('');
}

// =================================================================================
// 6. COMMANDS REGISTRY & HANDLER
// =================================================================================
const commands = [
    { regex: /^(hello|hi|hey)$/i, handler: async () => { const response = "Hello! How can I assist you today?"; UI.output.innerHTML = render.card("Greeting", response); speak(response); return { summary: "Greeting" }; } },
    { regex: /^(help|commands|what can you do)$/i, handler: async () => { const helpText = `<ul><li><b>news</b> - Get the latest news headlines.</li><li><b>weather in [city]</b> - Get the weather for a city.</li><li><b>what is/who is [topic]</b> - Search Wikipedia.</li><li><b>play [song/video]</b> - Play a video on YouTube.</li><li><b>open youtube</b> - Opens YouTube.</li><li><b>google/search [query]</b> - Perform a Google search.</li><li><b>time/date</b> - Get the current time or date.</li><li><b>joke/quote</b> - Get a random joke or quote.</li></ul>`; UI.output.innerHTML = render.card("Available Commands", helpText); speak("Here are some of the things I can do."); return { summary: "Displayed help" }; } },
    { regex: /time/i, handler: async () => { const t = new Date().toLocaleTimeString(); UI.output.innerHTML = render.card('Time', t); speak(`The time is ${t}`); return { summary: `Time: ${t}` }; } },
    { regex: /date/i, handler: async () => { const d = new Date().toLocaleDateString(); UI.output.innerHTML = render.card('Date', d); speak(`Today's date is ${d}`); return { summary: `Date: ${d}` }; } },
    { regex: /news/i, handler: async () => { const data = await api.getNews(); if (data.news?.length) { UI.output.innerHTML = render.news(data.news); speak('Here are the latest news headlines.'); return { summary: 'Fetched news' }; } else { throw new Error("No news available at the moment."); } } },
    { regex: /weather in (.+)/i, handler: async (matches) => { const city = matches[1]; const data = await api.getWeather(city); if (data.main && data.weather?.[0]) { const temp = (data.main.temp - 273.15).toFixed(1); const desc = data.weather[0].description; UI.output.innerHTML = render.weather(data, city); speak(`The temperature in ${city} is ${temp} degrees with ${desc}`); return { summary: `${temp}°C ${desc}` }; } else { throw new Error(`Could not find weather for ${city}.`); } } },
    { regex: /^(?:what is|who is|wikipedia|search for) (.+)/i, handler: async (matches) => { const query = matches[1]; const data = await api.getWikipedia(query); if (data.result) { UI.output.innerHTML = render.wikipedia(data.result); speak(data.result.extract || `Showing Wikipedia summary for ${data.result.title}`); return { summary: `Wiki: ${data.result.title}` }; } else { throw new Error(data.error || `No Wikipedia result found for ${query}.`); } } },
    
    /* --- NEW YOUTUBE COMMANDS START HERE --- */
    { 
        regex: /^play (.+?)(?: on youtube)?$/i, // Matches "play something" and "play something on youtube"
        handler: async (matches) => {
            const query = matches[1].trim();
            const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
            UI.output.innerHTML = render.card('YouTube', `Searching for "${escapeHtml(query)}" on YouTube... <a href="${url}" class="link" target="_blank">Click here if it doesn't open</a>`);
            window.open(url, '_blank'); // Opens the search in a new tab
            speak(`Searching for ${query} on YouTube.`);
            return { summary: `Searched YouTube for: ${query}` };
        } 
    },
    { 
        regex: /^open youtube$/i,
        handler: async () => {
            const url = 'https://www.youtube.com';
            UI.output.innerHTML = render.card('YouTube', `Opening YouTube... <a href="${url}" class="link" target="_blank">Click here if it doesn't open</a>`);
            window.open(url, '_blank');
            speak("Opening YouTube.");
            return { summary: "Opened YouTube" };
        }
    },
    /* --- NEW YOUTUBE COMMANDS END HERE --- */

    { regex: /^(?:google|search) (.+)/i, handler: async (matches) => { const query = matches[1]; UI.output.innerHTML = render.card('Google Search', `Searching for "${escapeHtml(query)}" on your machine...`); await api.searchGoogle(query); speak(`Launching Google search for ${query}.`); return { summary: `Googled: ${query}` }; } },
    { regex: /joke/i, handler: async () => { const data = await api.getJoke(); UI.output.innerHTML = render.card('😂 Joke', escapeHtml(data.joke)); speak(data.joke); return { summary: 'Told a joke' }; } },
    { regex: /quote/i, handler: async () => { const data = await api.getQuote(); const quoteText = `${data.quote} — ${data.author || 'Unknown'}`; UI.output.innerHTML = render.card('💡 Quote', escapeHtml(quoteText)); speak(`${data.quote} by ${data.author || 'an unknown author'}.`); return { summary: 'Shared a quote' }; } }
];
async function handleCommand(raw) {
    if (!raw) return;
    const cmd = raw.trim();
    UI.output.innerHTML = render.loading();
    UI.youSaid.innerHTML = `You said: <strong>${escapeHtml(cmd)}</strong>`;
    try {
        for (const command of commands) {
            const matches = cmd.match(command.regex);
            if (matches) {
                const result = await command.handler(matches);
                pushHistory(cmd, result.summary);
                return;
            }
        }
        throw new Error("I don't understand that command. Try 'help'.");
    } catch (err) {
        console.error(err);
        UI.output.innerHTML = render.error(err.message || String(err));
        speak("An error occurred. Please try again.");
    }
}

// =================================================================================
// 7. INITIALIZATION & EVENT LISTENERS
// =================================================================================
function init() {
    // --- THEME SETUP ---
    function applyTheme(theme) {
        if (theme === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
            UI.themeBtn.textContent = '🌙';
        } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            UI.themeBtn.textContent = '☀️';
        }
    }
    UI.themeBtn.onclick = () => {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    };
    const savedTheme = localStorage.getItem('theme') || 'dark';
    applyTheme(savedTheme);

    // --- TTS Toggle setup ---
    function updateTtsUI() {
        UI.ttsBtn.textContent = appState.ttsEnabled ? '🔊' : '🔇';
    }
    updateTtsUI();
    UI.ttsBtn.onclick = () => {
        appState.ttsEnabled = !appState.ttsEnabled;
        localStorage.setItem('va_ttsEnabled', appState.ttsEnabled);
        updateTtsUI();
    };

    // --- History setup ---
    renderHistory();
    UI.clearHistoryBtn.onclick = () => { appState.history = []; saveHistory(); };
    UI.historyDiv.addEventListener('click', e => {
        const item = e.target.closest('.hist-item');
        if (item && item.dataset.command) {
            handleCommand(item.dataset.command);
        }
    });

    // --- Input handlers ---
    UI.runBtn.onclick = () => handleCommand(UI.textInput.value);
    UI.textInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') handleCommand(UI.textInput.value);
    });
    UI.clearInputBtn.addEventListener('click', () => {
        UI.textInput.value = '';
        UI.clearInputBtn.classList.remove('visible');
        UI.textInput.focus();
    });
    UI.textInput.addEventListener('input', () => {
        if (UI.textInput.value.length > 0) {
            UI.clearInputBtn.classList.add('visible');
        } else {
            UI.clearInputBtn.classList.remove('visible');
        }
    });

    // --- Speech Recognition setup ---
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'en-IN';
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.onstart = () => { appState.isListening = true; UI.speakBtn.classList.add('listening'); UI.speakBtn.innerHTML = `<span class="mic-icon">Listening...</span>`; };
        recognition.onend = () => { appState.isListening = false; UI.speakBtn.classList.remove('listening'); UI.speakBtn.innerHTML = `<span class="mic-icon">🎤</span> Speak`; };
        recognition.onresult = e => { const text = e.results[0][0].transcript; handleCommand(text); };
        recognition.onerror = e => { console.error('Speech recognition error', e); UI.output.innerHTML = render.error(e.error || 'Microphone error. Please check permissions.'); };
        UI.speakBtn.onclick = () => { if (appState.isListening) { recognition.stop(); } else { recognition.start(); } };
    } else {
        UI.speakBtn.disabled = true;
        UI.speakBtn.title = 'Speech Recognition is not supported in this browser.';
        UI.speakBtn.innerHTML = `Unsupported`;
    }

    // --- REFINED: AESTHETIC 3D TILT EFFECT ---
    const mainElement = document.querySelector('main');
    if (mainElement) {
        document.body.addEventListener('mousemove', (e) => {
            if (window.innerWidth < 900) return; // Disable effect on smaller screens
            const { clientX, clientY } = e;
            const { innerWidth, innerHeight } = window;
            const halfWidth = innerWidth / 2;
            const halfHeight = innerHeight / 2;
            
            const rotateX = ((clientY - halfHeight) / halfHeight) * -3;
            const rotateY = ((clientX - halfWidth) / halfWidth) * 3;

            mainElement.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        });
        document.body.addEventListener('mouseleave', () => {
            mainElement.style.transform = `rotateX(0deg) rotateY(${0}deg)`;
        });
    }

    // --- NEW: Initialize Shooting Stars ---
    function createShootingStars(count) {
        const starsContainer = document.getElementById('shootingStars');
        if (!starsContainer) return; 
        for (let i = 0; i < count; i++) {
            const star = document.createElement('div');
            star.classList.add('shooting-star');
            const size = Math.random() * 2 + 1;
            star.style.width = `${size * 25}px`;
            star.style.height = `${size}px`;
            star.style.top = `${Math.random() * 100}vh`;
            star.style.left = `${Math.random() * 100}vw`;
            star.style.animationDelay = `${Math.random() * 10}s, ${Math.random() * 2}s`;
            star.style.animationDuration = `${Math.random() * 3 + 2}s, 2s`;
            starsContainer.appendChild(star);
        }
    }
    createShootingStars(15);
}

// Start the application
init();
</script>
</body>
</html>